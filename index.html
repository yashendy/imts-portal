<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ© - ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#4C9EE3;     /* Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­ */
      --accent:#5ECBAA;      /* Ø£Ø®Ø¶Ø± Ù†Ø¹Ù†Ø§Ø¹ÙŠ */
      --bg:#F7FAFC;          /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ø¬Ø¯Ø§ */
      --card:#FFFFFF;        /* Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ¶Ø§Ø¡ */
      --text:#1F2937;        /* Ù†Øµ Ø±Ø¦ÙŠØ³ÙŠ */
      --muted:#6B7280;       /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
      --danger:#e53935;
      --success:#2e7d32;
      --radius:16px;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --shadow-sm:0 6px 16px rgba(0,0,0,.05);
      --input:#E5EEF6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .page{
      min-height:100vh;
      display:grid;
      grid-template-columns: 1.2fr 1fr; /* ÙŠÙ…ÙŠÙ† Ø¹Ø±ÙŠØ¶ Ù„Ù„ØªØ¹Ø±ÙŠÙ - ÙŠØ³Ø§Ø± ÙÙˆØ±Ù… */
      gap:32px;
      padding:40px 24px;
      max-width:1200px;margin:0 auto;
    }
    /* Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØ¹Ø±ÙŠÙ */
    .hero{
      background:linear-gradient(135deg,#fff 0%, #f3fbff 60%, #e8faf4 100%);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:var(--shadow);
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:16px;margin-bottom:8px;
    }
    .brand img{width:58px;height:58px;object-fit:contain}
    .brand h1{margin:0;font-size:28px;color:#0f3c5f;line-height:1.3}
    .tag{color:var(--muted);margin:6px 0 16px}
    .bullets{margin:12px 0 24px;padding:0 0 0 12px}
    .bullets li{margin:10px 0;color:#355a74}
    .links{display:flex;gap:16px;flex-wrap:wrap}
    .link{color:var(--primary);text-decoration:none}
    .student-entry{
      border:2px dashed #b9e6ff;background:#f0fbff;color:#0a3c5c;
      padding:14px 18px;border-radius:12px;display:inline-flex;gap:10px;align-items:center;
      text-decoration:none;font-weight:600;
    }
    /* Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙÙˆØ±Ù… */
    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:24px;
    }
    .tabs{display:flex;gap:12px;border-bottom:2px solid #eef5fb;margin-bottom:16px;flex-wrap:wrap}
    .tab{
      appearance:none;border:none;background:transparent;
      padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;color:#2a5674;cursor:pointer;
    }
    .tab.active{background:#e6f4ff;color:#0d3b59}
    .form{display:none}
    .form.active{display:block;animation:fade .2s ease}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    label{display:block;font-size:14px;color:#355a74;margin:10px 4px 6px}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid var(--input);
      background:#fbfdff;outline:none;transition:.15s;border-color:var(--input);
      font-family:inherit;
    }
    input:focus,select:focus,textarea:focus{border-color:#a7d7ff;box-shadow:0 0 0 3px rgba(76,158,227,.15)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:12px}
    .btn{
      width:100%;padding:12px 16px;border:none;border-radius:12px;cursor:pointer;
      background:var(--primary);color:#fff;font-weight:800;box-shadow:var(--shadow-sm);
    }
    .btn.secondary{background:#ecfbf6;color:#0a6b53;border:1.5px solid #b8f0de}
    .btn.muted{background:#f2f6fa;color:#2b4a61}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .error,.success{
      padding:10px 12px;border-radius:10px;margin:10px 0;font-weight:700
    }
    .error{background:#fdecea;color:#9b1c1c;border:1px solid #f5c2c0}
    .success{background:#ebf7ee;color:#155724;border:1px solid #b7e2c0}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .divider{height:1px;background:#eef5fb;margin:14px 0}
    .subtle{color:var(--muted);font-size:13px}
    .center{display:flex;align-items:center;justify-content:center}
    .small{font-size:13px}
    @media (max-width: 980px){
      .page{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <main class="page">
    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„ØªØ¹Ø±ÙŠÙ -->
    <section class="hero">
      <div>
        <div class="brand">
          <img src="assets/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹Ù‡Ø¯">
          <div>
            <h1>Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©</h1>
            <div class="tag">Ù„ØªØ¯Ø±ÙŠØ³ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…ØµØ±ÙŠ</div>
          </div>
        </div>

        <ul class="bullets">
          <li>ØªØ¹Ù„Ù… Ù…ØªÙ…ÙŠØ² Ù„Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</li>
          <li>Ù…Ù†ØµØ© Ø´Ø§Ù…Ù„Ø© Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</li>
          <li>Ø¯Ø®ÙˆÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„</li>
        </ul>

        <a class="student-entry" href="student.html" title="Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„">
          ğŸ“ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
        </a>
      </div>

      <div class="links">
        <a class="link" href="#" onclick="showTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        <a class="link" href="#" onclick="showTab('invite')">Ø£Ù…ØªÙ„Ùƒ ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ©</a>
        <span class="subtle">Ø¨Ø¯Ø¹Ù… Firebase</span>
      </div>
    </section>

    <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„ÙƒØ±ÙˆØª/Ø§Ù„ÙÙˆØ±Ù… -->
    <section class="card">
      <div class="tabs">
        <button class="tab active" id="tab-login"  onclick="showTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="tab" id="tab-teacher" onclick="showTab('teacher')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„Ù‘Ù…</button>
        <button class="tab" id="tab-admin"   onclick="showTab('admin')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù†</button>
        <button class="tab" id="tab-invite"  onclick="showTab('invite')">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ©</button>
      </div>

      <!-- Ø±Ø³Ø§Ø¦Ù„ Ø¹Ø§Ù…Ø© -->
      <div id="globalMsg"></div>

      <!-- ÙÙˆØ±Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <form id="form-login" class="form active" onsubmit="login(event)">
        <div class="top-actions">
          <button type="button" class="btn muted small" onclick="passwordReset()">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
          <span class="subtle">Ù„Ø§ ØªÙ…ØªÙ„Ùƒ Ø­Ø³Ø§Ø¨Ù‹Ø§ØŸ Ø§Ø®ØªØ± ØªØ¨ÙˆÙŠØ¨ â€œØ¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨â€.</span>
        </div>
        <label for="loginEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="loginEmail" type="email" autocomplete="username" required>

        <label for="loginPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="loginPass" type="password" autocomplete="current-password" minlength="6" required>

        <div class="hint">Ø¨Ø¯Ø®ÙˆÙ„Ùƒ ÙØ£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©.</div>
        <div class="divider"></div>

        <button class="btn" type="submit">Ø¯Ø®ÙˆÙ„</button>
      </form>

      <!-- ÙÙˆØ±Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„Ù‘Ù… -->
      <form id="form-teacher" class="form" onsubmit="signupTeacher(event)">
        <div class="grid">
          <div>
            <label for="tName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input id="tName" type="text" required>
          </div>
          <div>
            <label for="tPhone">Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="tPhone" type="tel" pattern="^[0-9+\-\s]{6,}$" placeholder="01xxxxxxxxx">
          </div>
        </div>
        <label for="tEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="tEmail" type="email" autocomplete="username" required>

        <div class="grid">
          <div>
            <label for="tPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="tPass" type="password" autocomplete="new-password" minlength="6" required>
          </div>
          <div>
            <label for="tPass2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="tPass2" type="password" minlength="6" required>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="tStage">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</label>
            <select id="tStage" required>
              <option value="" selected disabled>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>
            </select>
          </div>
          <div>
            <label for="tTrack">Ø§Ù„Ù…Ø³Ø§Ø±</label>
            <select id="tTrack">
              <option value="" selected>â€”</option>
            </select>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="tGrades">Ø§Ù„ØµÙÙˆÙ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙ)</label>
            <select id="tGrades" multiple size="4"></select>
            <div class="subtle small">Ø§Ø¶ØºØ· Ctrl/âŒ˜ Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯</div>
          </div>
          <div>
            <label for="tSubjects">Ø§Ù„Ù…ÙˆØ§Ø¯ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø§Ø¯Ø©)</label>
            <select id="tSubjects" multiple size="4"></select>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="tExp">Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©</label>
            <input id="tExp" type="number" min="0" max="60" value="0">
          </div>
          <div>
            <label for="tCity">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©/Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="tCity" type="text">
          </div>
        </div>

        <label for="tBio">Ù†Ø¨Ø°Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <textarea id="tBio" rows="3" placeholder="Ù†Ø¨Ø°Ø© Ù…Ø®ØªØµØ±Ø© Ø¹Ù†Ùƒ"></textarea>

        <div class="divider"></div>
        <button class="btn" type="submit">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„Ù‘Ù…</button>
        <div class="row">
          <button class="btn secondary" type="button" onclick="showTab('invite')">Ø¹Ù†Ø¯ÙŠ ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ©</button>
          <a class="btn muted center" href="student.html" role="button">Ø§Ù„Ø¥Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
        </div>
      </form>

      <!-- ÙÙˆØ±Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù† (Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© ÙÙ‚Ø·) -->
      <form id="form-admin" class="form" onsubmit="signupAdmin(event)">
        <div class="grid">
          <div>
            <label for="aName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input id="aName" type="text" required>
          </div>
          <div>
            <label for="aPhone">Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="aPhone" type="tel" pattern="^[0-9+\-\s]{6,}$" placeholder="01xxxxxxxxx">
          </div>
        </div>

        <label for="aEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input id="aEmail" type="email" autocomplete="username" required>

        <div class="grid">
          <div>
            <label for="aPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="aPass" type="password" autocomplete="new-password" minlength="6" required>
          </div>
          <div>
            <label for="aPass2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="aPass2" type="password" minlength="6" required>
          </div>
        </div>

        <div class="divider"></div>
        <button class="btn" type="submit">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø£Ø¯Ù…Ù†</button>
        <div class="row">
          <button class="btn secondary" type="button" onclick="showTab('invite')">Ø¹Ù†Ø¯ÙŠ ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ©</button>
          <a class="btn muted center" href="student.html" role="button">Ø§Ù„Ø¥Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</a>
        </div>
        <div class="hint">Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ø§Ù†: Ù„Ù† ØªÙÙØ¹Ù‘Ù„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ <b>ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ© Ø£Ø¯Ù…Ù†</b> ØµØ§Ù„Ø­.</div>
      </form>

      <!-- ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ© -->
      <form id="form-invite" class="form" onsubmit="activateInvite(event)">
        <p class="subtle">Ø£Ø¯Ø®Ù„ <b>ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©</b> Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ„Ù…ØªÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©. Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù‚Ù‚ Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©.</p>
        <label for="inviteCode">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©</label>
        <input id="inviteCode" pattern="^[A-Za-z0-9_-]{4,}$" required placeholder="Ù…Ø«Ø§Ù„: TEACHER-ABC123">
        <div class="divider"></div>
        <button class="btn" type="submit">ØªØ­Ù‚Ù‚ ÙˆØªÙØ¹ÙŠÙ„</button>
        <div class="hint">Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† <b>Ù†Ø´Ø·Ù‹Ø§</b> ÙˆÙ„Ù… ØªÙ†ØªÙ‡Ù ØµÙ„Ø§Ø­ÙŠØªÙ‡ ÙˆÙÙ‚ Ù‚ÙˆØ§Ø¹Ø¯ Firestore.</div>
      </form>

    </section>
  </main>

  <!-- Firebase + Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script type="module">
    /************* Firebase Setup *************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      updateProfile, sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp,
      collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---- Config Ù…Ù† Ø·Ø±ÙÙƒ ----
    const firebaseConfig = {
      apiKey: "AIzaSyCoZ19SWabidrkmrX8SWy4rFbpWnuYtSSM",
      authDomain: "imts-4b827.firebaseapp.com",
      projectId: "imts-4b827",
      storageBucket: "imts-4b827.firebasestorage.app",
      messagingSenderId: "607673793508",
      appId: "1:607673793508:web:d8dbf01a99ce4b7b8565f1",
      measurementId: "G-3YVBHGWJ9V"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /************* ØªØ¨ÙˆÙŠØ¨Ø§Øª *************/
    const tabs = ["login","teacher","admin","invite"];
    function showTab(name){
      tabs.forEach(t=>{
        document.getElementById(`form-${t}`).classList.toggle('active', t===name);
        document.getElementById(`tab-${t}`).classList.toggle('active', t===name);
      });
      clearGlobal();
    }
    window.showTab = showTab;

    /************* Helpers *************/
    const $ = s => document.querySelector(s);
    const msgBox = $("#globalMsg");
    function alertError(text){ msgBox.innerHTML = `<div class="error">${escapeHtml(text)}</div>`; }
    function alertSuccess(text){ msgBox.innerHTML = `<div class="success">${escapeHtml(text)}</div>`; }
    function clearGlobal(){ msgBox.innerHTML = ""; }
    function escapeHtml(s){ return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    const toArray = (selectEl)=> Array.from(selectEl.selectedOptions).map(o=>o.value).filter(Boolean);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ø§Ù…Ø© (grades/tracks/subjects/stages Ù…Ù† settings)
    async function loadCatalogs(){
      try{
        // stages Ù…Ù† settings (Ø¥Ù† ÙˆØ¬Ø¯Øª) ÙˆØ¥Ù„Ø§ fallback Ø«Ø§Ø¨Øª
        const stagesSel = $("#tStage");
        stagesSel.innerHTML = `<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø©</option>`;
        const settingsDoc = await getDoc(doc(db,"settings","ui")); // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ doc Ø§Ø³Ù…Ù‡ ui
        const stages = settingsDoc.exists() && Array.isArray(settingsDoc.data().stages)
            ? settingsDoc.data().stages : ["Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ","Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ","Ø«Ø§Ù†ÙˆÙŠ"];
        stages.forEach(v=> stagesSel.insertAdjacentHTML("beforeend", `<option value="${v}">${v}</option>`));

        const tracksSel   = $("#tTrack");
        tracksSel.innerHTML = `<option value="" selected>â€”</option>`;
        const tracksSnap = await getDocs(collection(db,"tracks"));
        tracksSnap.forEach(d=> tracksSel.insertAdjacentHTML("beforeend", `<option value="${d.id}">${d.data().name || d.id}</option>`));

        const gradesSel   = $("#tGrades");
        gradesSel.innerHTML = ``;
        const gradesSnap = await getDocs(collection(db,"grades"));
        gradesSnap.forEach(d=> gradesSel.insertAdjacentHTML("beforeend", `<option value="${d.id}">${d.data().name || d.id}</option>`));

        const subjSel     = $("#tSubjects");
        subjSel.innerHTML = ``;
        const subjSnap = await getDocs(collection(db,"subjects"));
        subjSnap.forEach(d=> subjSel.insertAdjacentHTML("beforeend", `<option value="${d.id}">${d.data().name || d.id}</option>`));
      }catch(e){
        console.warn(e);
      }
    }
    loadCatalogs();

    /************* Auth State *************/
    onAuthStateChanged(auth, async (user)=>{
      if(!user) return; // Ù„ÙŠØ³ Ù…Ø³Ø¬Ù„Ù‹Ø§
      try{
        const uref = doc(db,"users", user.uid);
        const us   = await getDoc(uref);
        if(us.exists()){
          const data = us.data();
          if(data.status === "active" && (data.role === "teacher" || data.role === "admin" || data.role === "owner")){
            // ØªØ­ÙˆÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
            if(data.role === "teacher") window.location.href = "teacher-dashboard.html";
            else window.location.href = "admin-dashboard.html"; // admin & owner
          }else{
            // Ù…Ø­ØªØ§Ø¬ ØªÙØ¹ÙŠÙ„
            showTab("invite");
            alertSuccess("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨.");
          }
        }else{
          // Ù„Ùˆ Ù…ÙÙŠØ´ ÙˆØ«ÙŠÙ‚Ø© Ù…Ø³ØªØ®Ø¯Ù… (Ø­Ø§Ù„Ø© Ù†Ø§Ø¯Ø±Ø©): Ù†Ø·Ù„Ø¨ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          showTab("invite");
          alertError("Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©. Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨.");
        }
      }catch(e){
        alertError("ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + (e.message || e));
      }
    });

    /************* Login *************/
    window.login = async (ev)=>{
      ev.preventDefault(); clearGlobal();
      const email = $("#loginEmail").value.trim();
      const pass  = $("#loginPass").value;
      if(!email || pass.length < 6){ return alertError("ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù¦ Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)."); }
      try{
        const cred = await signInWithEmailAndPassword(auth,email,pass);
        // onAuthStateChanged Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ø§Ù‚ÙŠ (ØªÙˆØ¬ÙŠÙ‡)
        alertSuccess("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„â€¦");
      }catch(e){ handleAuthError(e); }
    };

    async function passwordReset(){
      try{
        const email = prompt("Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†:");
        if(!email) return;
        await sendPasswordResetEmail(auth, email);
        alertSuccess("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ.");
      }catch(e){ handleAuthError(e); }
    }
    window.passwordReset = passwordReset;

    /************* Signup Teacher *************/
    window.signupTeacher = async (ev)=>{
      ev.preventDefault(); clearGlobal();

      const name = $("#tName").value.trim();
      const phone= $("#tPhone").value.trim();
      const email= $("#tEmail").value.trim();
      const pass = $("#tPass").value;
      const pass2= $("#tPass2").value;

      if(!name) return alertError("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨.");
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alertError("ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      if(pass.length < 6) return alertError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† Ù¦ Ø£Ø­Ø±Ù.");
      if(pass !== pass2) return alertError("ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.");

      const stage   = $("#tStage").value;
      const track   = $("#tTrack").value || null;
      const grades  = toArray($("#tGrades"));
      const subjects= toArray($("#tSubjects"));
      const exp     = Number($("#tExp").value || 0);
      const city    = $("#tCity").value.trim() || null;
      const bio     = $("#tBio").value.trim() || null;

      if(!stage) return alertError("Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù…Ø·Ù„ÙˆØ¨Ø©.");

      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(cred.user,{ displayName:name });

        // guard: ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (status: pending)
        await setDoc(doc(db,"users", cred.user.uid),{
          displayName:name,
          email,
          phone: phone || null,
          role: "pending",
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          teacher:{
            stage, track, grades, subjects,
            experienceYears: exp,
            city, bio
          }
        }, { merge:true });

        showTab("invite");
        alertSuccess("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù….");
      }catch(e){ handleAuthError(e); }
    };

    /************* Signup Admin (personal only) *************/
    window.signupAdmin = async (ev)=>{
      ev.preventDefault(); clearGlobal();

      const name = $("#aName").value.trim();
      const phone= $("#aPhone").value.trim();
      const email= $("#aEmail").value.trim();
      const pass = $("#aPass").value;
      const pass2= $("#aPass2").value;

      if(!name) return alertError("Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨.");
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alertError("ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
      if(pass.length < 6) return alertError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù„Ø§ ØªÙ‚Ù„ Ø¹Ù† Ù¦ Ø£Ø­Ø±Ù.");
      if(pass !== pass2) return alertError("ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚.");

      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(cred.user,{ displayName:name });

        await setDoc(doc(db,"users", cred.user.uid),{
          displayName:name,
          email,
          phone: phone || null,
          role: "pending",      // Ù„Ù† ÙŠØµØ¨Ø­ Admin Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø¹ÙˆØ©
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        showTab("invite");
        alertSuccess("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. Ø£Ø¯Ø®Ù„ <b>ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ© Ø£Ø¯Ù…Ù†</b> Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.");
      }catch(e){ handleAuthError(e); }
    };

    /************* Invite Activation *************/
    window.activateInvite = async (ev)=>{
      ev.preventDefault(); clearGlobal();
      const code = $("#inviteCode").value.trim();
      if(!code) return alertError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©.");

      const user = auth.currentUser;
      if(!user){ showTab("login"); return alertError("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø«Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯."); }

      try{
        // get ÙÙ‚Ø· ÙˆÙÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯
        const invSnap = await getDoc(doc(db,"invites", code));
        if(!invSnap.exists()) return alertError("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­.");
        const inv = invSnap.data();

        // Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ØªÙ…Ù†Ø­ get ÙÙ‚Ø· Ù„Ùˆ active==true ÙˆÙ„Ù… ØªÙ†ØªÙ‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        // Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØªØ­ØªÙˆÙŠ role: teacher|admin
        const role = inv.role;
        if(!["teacher","admin"].includes(role)) return alertError("Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø¹ÙˆØ© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.");

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await setDoc(doc(db,"users", user.uid),{
          role,
          status:"active",
          updatedAt: serverTimestamp()
        }, { merge:true });

        alertSuccess("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±Ù ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©â€¦");
        setTimeout(()=>{
          if(role==="teacher") window.location.href="teacher-dashboard.html";
          else window.location.href="admin-dashboard.html";
        }, 700);
      }catch(e){
        handleAuthError(e);
      }
    };

    /************* Errors Map *************/
    function handleAuthError(e){
      const code = (e && e.code) || "";
      const map = {
        "auth/email-already-in-use": "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§.",
        "auth/invalid-email": "Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ§Ù„Ø­.",
        "auth/weak-password": "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (Ù¦ Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).",
        "auth/user-not-found": "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚.",
        "auth/wrong-password": "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.",
        "auth/too-many-requests": "Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§.",
        "permission-denied": "Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø¨ Ù‚ÙˆØ§Ø¹Ø¯ Firestore.",
      };
      console.error(e);
      alertError(map[code] || e.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹.");
    }

    // Ø§Ø®ØªØµØ§Ø± Ù„Ù„Ø®Ø±ÙˆØ¬ (Ù…ÙÙŠØ¯ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ±)
    window.appSignOut = async ()=>{ await signOut(auth); alertSuccess("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬."); showTab("login"); };
  </script>
</body>
</html>
