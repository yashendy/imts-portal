<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>معهد الدراسات الإدارية والفنية - تسجيل / دخول</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#4C9EE3;     /* أزرق فاتح */
      --accent:#5ECBAA;      /* أخضر نعناعي */
      --bg:#F7FAFC;          /* خلفية فاتحة جدا */
      --card:#FFFFFF;        /* بطاقة بيضاء */
      --text:#1F2937;        /* نص رئيسي */
      --muted:#6B7280;       /* نص ثانوي */
      --danger:#e53935;
      --success:#2e7d32;
      --radius:16px;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --shadow-sm:0 6px 16px rgba(0,0,0,.05);
      --input:#E5EEF6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .page{
      min-height:100vh;
      display:grid;
      grid-template-columns: 1.2fr 1fr; /* يمين عريض للتعريف - يسار فورم */
      gap:32px;
      padding:40px 24px;
      max-width:1200px;margin:0 auto;
    }
    /* عمود التعريف */
    .hero{
      background:linear-gradient(135deg,#fff 0%, #f3fbff 60%, #e8faf4 100%);
      border-radius:var(--radius);
      padding:32px;
      box-shadow:var(--shadow);
      display:flex;flex-direction:column;justify-content:space-between;
    }
    .brand{
      display:flex;align-items:center;gap:16px;margin-bottom:8px;
    }
    .brand img{width:58px;height:58px;object-fit:contain}
    .brand h1{margin:0;font-size:28px;color:#0f3c5f;line-height:1.3}
    .tag{color:var(--muted);margin:6px 0 16px}
    .bullets{margin:12px 0 24px;padding:0 0 0 12px}
    .bullets li{margin:10px 0;color:#355a74}
    .links{display:flex;gap:16px;flex-wrap:wrap}
    .link{color:var(--primary);text-decoration:none}
    .student-entry{
      border:2px dashed #b9e6ff;background:#f0fbff;color:#0a3c5c;
      padding:14px 18px;border-radius:12px;display:inline-flex;gap:10px;align-items:center;
      text-decoration:none;font-weight:600;
    }
    /* عمود الفورم */
    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:24px;
    }
    .tabs{display:flex;gap:12px;border-bottom:2px solid #eef5fb;margin-bottom:16px;flex-wrap:wrap}
    .tab{
      appearance:none;border:none;background:transparent;
      padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;color:#2a5674;cursor:pointer;
    }
    .tab.active{background:#e6f4ff;color:#0d3b59}
    .form{display:none}
    .form.active{display:block;animation:fade .2s ease}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
    label{display:block;font-size:14px;color:#355a74;margin:10px 4px 6px}
    input,select,textarea{
      width:100%;padding:12px 14px;border-radius:12px;border:1.5px solid var(--input);
      background:#fbfdff;outline:none;transition:.15s;border-color:var(--input);
      font-family:inherit;
    }
    input:focus,select:focus,textarea:focus{border-color:#a7d7ff;box-shadow:0 0 0 3px rgba(76,158,227,.15)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row{display:flex;gap:12px}
    .btn{
      width:100%;padding:12px 16px;border:none;border-radius:12px;cursor:pointer;
      background:var(--primary);color:#fff;font-weight:800;box-shadow:var(--shadow-sm);
    }
    .btn.secondary{background:#ecfbf6;color:#0a6b53;border:1.5px solid #b8f0de}
    .btn.muted{background:#f2f6fa;color:#2b4a61}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .error,.success{
      padding:10px 12px;border-radius:10px;margin:10px 0;font-weight:700
    }
    .error{background:#fdecea;color:#9b1c1c;border:1px solid #f5c2c0}
    .success{background:#ebf7ee;color:#155724;border:1px solid #b7e2c0}
    .top-actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .divider{height:1px;background:#eef5fb;margin:14px 0}
    .subtle{color:var(--muted);font-size:13px}
    .center{display:flex;align-items:center;justify-content:center}
    .small{font-size:13px}
    @media (max-width: 980px){
      .page{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <main class="page">
    <!-- العمود الأيمن: التعريف -->
    <section class="hero">
      <div>
        <div class="brand">
          <img src="assets/logo.png" alt="شعار المعهد">
          <div>
            <h1>معهد الدراسات الإدارية والفنية</h1>
            <div class="tag">لتدريس المنهج المصري</div>
          </div>
        </div>

        <ul class="bullets">
          <li>تعلم متميز للطلاب والمعلمين</li>
          <li>منصة شاملة لأدوات التعلم والإدارة</li>
          <li>دخول سريع للطالب بدون تسجيل</li>
        </ul>

        <a class="student-entry" href="student.html" title="لوحة الطالب بدون تسجيل">
          🎓 الذهاب إلى لوحة الطالب
        </a>
      </div>

      <div class="links">
        <a class="link" href="#" onclick="showTab('login')">تسجيل الدخول</a>
        <a class="link" href="#" onclick="showTab('invite')">أمتلك كود دعوة</a>
        <span class="subtle">بدعم Firebase</span>
      </div>
    </section>

    <!-- العمود الأيسر: الكروت/الفورم -->
    <section class="card">
      <div class="tabs">
        <button class="tab active" id="tab-login"  onclick="showTab('login')">تسجيل الدخول</button>
        <button class="tab" id="tab-teacher" onclick="showTab('teacher')">إنشاء حساب مُعلّم</button>
        <button class="tab" id="tab-admin"   onclick="showTab('admin')">إنشاء حساب أدمن</button>
        <button class="tab" id="tab-invite"  onclick="showTab('invite')">تفعيل الدعوة</button>
      </div>

      <!-- رسائل عامة -->
      <div id="globalMsg"></div>

      <!-- فورم تسجيل الدخول -->
      <form id="form-login" class="form active" onsubmit="login(event)">
        <div class="top-actions">
          <button type="button" class="btn muted small" onclick="passwordReset()">نسيت كلمة المرور؟</button>
          <span class="subtle">لا تمتلك حسابًا؟ اختر تبويب “إنشاء حساب”.</span>
        </div>
        <label for="loginEmail">البريد الإلكتروني</label>
        <input id="loginEmail" type="email" autocomplete="username" required>

        <label for="loginPass">كلمة المرور</label>
        <input id="loginPass" type="password" autocomplete="current-password" minlength="6" required>

        <div class="hint">بدخولك فأنت توافق على الشروط وسياسة الخصوصية.</div>
        <div class="divider"></div>

        <button class="btn" type="submit">دخول</button>
      </form>

      <!-- فورم إنشاء حساب مُعلّم -->
      <form id="form-teacher" class="form" onsubmit="signupTeacher(event)">
        <div class="grid">
          <div>
            <label for="tName">الاسم الكامل</label>
            <input id="tName" type="text" required>
          </div>
          <div>
            <label for="tPhone">الهاتف (اختياري)</label>
            <input id="tPhone" type="tel" pattern="^[0-9+\-\s]{6,}$" placeholder="01xxxxxxxxx">
          </div>
        </div>
        <label for="tEmail">البريد الإلكتروني</label>
        <input id="tEmail" type="email" autocomplete="username" required>

        <div class="grid">
          <div>
            <label for="tPass">كلمة المرور</label>
            <input id="tPass" type="password" autocomplete="new-password" minlength="6" required>
          </div>
          <div>
            <label for="tPass2">تأكيد كلمة المرور</label>
            <input id="tPass2" type="password" minlength="6" required>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="tStage">المرحلة التعليمية</label>
            <select id="tStage" required>
              <option value="" selected disabled>اختر المرحلة</option>
            </select>
          </div>
          <div>
            <label for="tTrack">المسار</label>
            <select id="tTrack">
              <option value="" selected>—</option>
            </select>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="tGrades">الصفوف (يمكن اختيار أكثر من صف)</label>
            <select id="tGrades" multiple size="4"></select>
            <div class="subtle small">اضغط Ctrl/⌘ لاختيار متعدد</div>
          </div>
          <div>
            <label for="tSubjects">المواد (يمكن اختيار أكثر من مادة)</label>
            <select id="tSubjects" multiple size="4"></select>
          </div>
        </div>

        <div class="grid">
          <div>
            <label for="tExp">سنوات الخبرة</label>
            <input id="tExp" type="number" min="0" max="60" value="0">
          </div>
          <div>
            <label for="tCity">المحافظة/المدينة (اختياري)</label>
            <input id="tCity" type="text">
          </div>
        </div>

        <label for="tBio">نبذة (اختياري)</label>
        <textarea id="tBio" rows="3" placeholder="نبذة مختصرة عنك"></textarea>

        <div class="divider"></div>
        <button class="btn" type="submit">إنشاء حساب مُعلّم</button>
        <div class="row">
          <button class="btn secondary" type="button" onclick="showTab('invite')">عندي كود دعوة</button>
          <a class="btn muted center" href="student.html" role="button">الإنتقال إلى لوحة الطالب</a>
        </div>
      </form>

      <!-- فورم إنشاء حساب أدمن (بيانات شخصية فقط) -->
      <form id="form-admin" class="form" onsubmit="signupAdmin(event)">
        <div class="grid">
          <div>
            <label for="aName">الاسم الكامل</label>
            <input id="aName" type="text" required>
          </div>
          <div>
            <label for="aPhone">الهاتف (اختياري)</label>
            <input id="aPhone" type="tel" pattern="^[0-9+\-\s]{6,}$" placeholder="01xxxxxxxxx">
          </div>
        </div>

        <label for="aEmail">البريد الإلكتروني</label>
        <input id="aEmail" type="email" autocomplete="username" required>

        <div class="grid">
          <div>
            <label for="aPass">كلمة المرور</label>
            <input id="aPass" type="password" autocomplete="new-password" minlength="6" required>
          </div>
          <div>
            <label for="aPass2">تأكيد كلمة المرور</label>
            <input id="aPass2" type="password" minlength="6" required>
          </div>
        </div>

        <div class="divider"></div>
        <button class="btn" type="submit">إنشاء حساب أدمن</button>
        <div class="row">
          <button class="btn secondary" type="button" onclick="showTab('invite')">عندي كود دعوة</button>
          <a class="btn muted center" href="student.html" role="button">الإنتقال إلى لوحة الطالب</a>
        </div>
        <div class="hint">لأسباب أمان: لن تُفعّل صلاحيات الأدمن إلا بعد إدخال <b>كود دعوة أدمن</b> صالح.</div>
      </form>

      <!-- تفعيل الدعوة -->
      <form id="form-invite" class="form" onsubmit="activateInvite(event)">
        <p class="subtle">أدخل <b>كود الدعوة</b> الذي استلمته من الإدارة. عند نجاح التحقق سيتم تفعيل حسابك وتوجيهك للوحة المناسبة.</p>
        <label for="inviteCode">كود الدعوة</label>
        <input id="inviteCode" pattern="^[A-Za-z0-9_-]{4,}$" required placeholder="مثال: TEACHER-ABC123">
        <div class="divider"></div>
        <button class="btn" type="submit">تحقق وتفعيل</button>
        <div class="hint">الكود يجب أن يكون <b>نشطًا</b> ولم تنتهِ صلاحيته وفق قواعد Firestore.</div>
      </form>

    </section>
  </main>

  <!-- Firebase + منطق الصفحة -->
  <script type="module">
    /************* Firebase Setup *************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      updateProfile, sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp,
      collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---- Config من طرفك ----
    const firebaseConfig = {
      apiKey: "AIzaSyCoZ19SWabidrkmrX8SWy4rFbpWnuYtSSM",
      authDomain: "imts-4b827.firebaseapp.com",
      projectId: "imts-4b827",
      storageBucket: "imts-4b827.firebasestorage.app",
      messagingSenderId: "607673793508",
      appId: "1:607673793508:web:d8dbf01a99ce4b7b8565f1",
      measurementId: "G-3YVBHGWJ9V"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /************* تبويبات *************/
    const tabs = ["login","teacher","admin","invite"];
    function showTab(name){
      tabs.forEach(t=>{
        document.getElementById(`form-${t}`).classList.toggle('active', t===name);
        document.getElementById(`tab-${t}`).classList.toggle('active', t===name);
      });
      clearGlobal();
    }
    window.showTab = showTab;

    /************* Helpers *************/
    const $ = s => document.querySelector(s);
    const msgBox = $("#globalMsg");
    function alertError(text){ msgBox.innerHTML = `<div class="error">${escapeHtml(text)}</div>`; }
    function alertSuccess(text){ msgBox.innerHTML = `<div class="success">${escapeHtml(text)}</div>`; }
    function clearGlobal(){ msgBox.innerHTML = ""; }
    function escapeHtml(s){ return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    const toArray = (selectEl)=> Array.from(selectEl.selectedOptions).map(o=>o.value).filter(Boolean);

    // تحميل القوائم العامة (grades/tracks/subjects/stages من settings)
    async function loadCatalogs(){
      try{
        // stages من settings (إن وجدت) وإلا fallback ثابت
        const stagesSel = $("#tStage");
        stagesSel.innerHTML = `<option value="" disabled selected>اختر المرحلة</option>`;
        const settingsDoc = await getDoc(doc(db,"settings","ui")); // لو عندك doc اسمه ui
        const stages = settingsDoc.exists() && Array.isArray(settingsDoc.data().stages)
            ? settingsDoc.data().stages : ["ابتدائي","إعدادي","ثانوي"];
        stages.forEach(v=> stagesSel.insertAdjacentHTML("beforeend", `<option value="${v}">${v}</option>`));

        const tracksSel   = $("#tTrack");
        tracksSel.innerHTML = `<option value="" selected>—</option>`;
        const tracksSnap = await getDocs(collection(db,"tracks"));
        tracksSnap.forEach(d=> tracksSel.insertAdjacentHTML("beforeend", `<option value="${d.id}">${d.data().name || d.id}</option>`));

        const gradesSel   = $("#tGrades");
        gradesSel.innerHTML = ``;
        const gradesSnap = await getDocs(collection(db,"grades"));
        gradesSnap.forEach(d=> gradesSel.insertAdjacentHTML("beforeend", `<option value="${d.id}">${d.data().name || d.id}</option>`));

        const subjSel     = $("#tSubjects");
        subjSel.innerHTML = ``;
        const subjSnap = await getDocs(collection(db,"subjects"));
        subjSnap.forEach(d=> subjSel.insertAdjacentHTML("beforeend", `<option value="${d.id}">${d.data().name || d.id}</option>`));
      }catch(e){
        console.warn(e);
      }
    }
    loadCatalogs();

    /************* Auth State *************/
    onAuthStateChanged(auth, async (user)=>{
      if(!user) return; // ليس مسجلًا
      try{
        const uref = doc(db,"users", user.uid);
        const us   = await getDoc(uref);
        if(us.exists()){
          const data = us.data();
          if(data.status === "active" && (data.role === "teacher" || data.role === "admin" || data.role === "owner")){
            // تحويل مباشر للداشبورد
            if(data.role === "teacher") window.location.href = "teacher-dashboard.html";
            else window.location.href = "admin-dashboard.html"; // admin & owner
          }else{
            // محتاج تفعيل
            showTab("invite");
            alertSuccess("مرحبًا بك! الرجاء إدخال كود الدعوة لتفعيل الحساب.");
          }
        }else{
          // لو مفيش وثيقة مستخدم (حالة نادرة): نطلب إكمال البيانات
          showTab("invite");
          alertError("حسابك بحاجة لإكمال التهيئة. أدخل كود الدعوة لتفعيل الحساب.");
        }
      }catch(e){
        alertError("تعذّر جلب بيانات المستخدم: " + (e.message || e));
      }
    });

    /************* Login *************/
    window.login = async (ev)=>{
      ev.preventDefault(); clearGlobal();
      const email = $("#loginEmail").value.trim();
      const pass  = $("#loginPass").value;
      if(!email || pass.length < 6){ return alertError("تحقق من البريد وكلمة المرور (٦ أحرف على الأقل)."); }
      try{
        const cred = await signInWithEmailAndPassword(auth,email,pass);
        // onAuthStateChanged سيقوم بالباقي (توجيه)
        alertSuccess("تم الدخول بنجاح، جارٍ التحويل…");
      }catch(e){ handleAuthError(e); }
    };

    async function passwordReset(){
      try{
        const email = prompt("أدخل بريدك لإرسال رابط إعادة التعيين:");
        if(!email) return;
        await sendPasswordResetEmail(auth, email);
        alertSuccess("تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك.");
      }catch(e){ handleAuthError(e); }
    }
    window.passwordReset = passwordReset;

    /************* Signup Teacher *************/
    window.signupTeacher = async (ev)=>{
      ev.preventDefault(); clearGlobal();

      const name = $("#tName").value.trim();
      const phone= $("#tPhone").value.trim();
      const email= $("#tEmail").value.trim();
      const pass = $("#tPass").value;
      const pass2= $("#tPass2").value;

      if(!name) return alertError("الاسم الكامل مطلوب.");
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alertError("صيغة البريد غير صحيحة.");
      if(pass.length < 6) return alertError("كلمة المرور يجب ألا تقل عن ٦ أحرف.");
      if(pass !== pass2) return alertError("تأكيد كلمة المرور غير مطابق.");

      const stage   = $("#tStage").value;
      const track   = $("#tTrack").value || null;
      const grades  = toArray($("#tGrades"));
      const subjects= toArray($("#tSubjects"));
      const exp     = Number($("#tExp").value || 0);
      const city    = $("#tCity").value.trim() || null;
      const bio     = $("#tBio").value.trim() || null;

      if(!stage) return alertError("المرحلة التعليمية مطلوبة.");

      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(cred.user,{ displayName:name });

        // guard: وثيقة المستخدم (status: pending)
        await setDoc(doc(db,"users", cred.user.uid),{
          displayName:name,
          email,
          phone: phone || null,
          role: "pending",
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          teacher:{
            stage, track, grades, subjects,
            experienceYears: exp,
            city, bio
          }
        }, { merge:true });

        showTab("invite");
        alertSuccess("تم إنشاء الحساب. أدخل كود الدعوة لتفعيل حساب المعلّم.");
      }catch(e){ handleAuthError(e); }
    };

    /************* Signup Admin (personal only) *************/
    window.signupAdmin = async (ev)=>{
      ev.preventDefault(); clearGlobal();

      const name = $("#aName").value.trim();
      const phone= $("#aPhone").value.trim();
      const email= $("#aEmail").value.trim();
      const pass = $("#aPass").value;
      const pass2= $("#aPass2").value;

      if(!name) return alertError("الاسم الكامل مطلوب.");
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return alertError("صيغة البريد غير صحيحة.");
      if(pass.length < 6) return alertError("كلمة المرور يجب ألا تقل عن ٦ أحرف.");
      if(pass !== pass2) return alertError("تأكيد كلمة المرور غير مطابق.");

      try{
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        await updateProfile(cred.user,{ displayName:name });

        await setDoc(doc(db,"users", cred.user.uid),{
          displayName:name,
          email,
          phone: phone || null,
          role: "pending",      // لن يصبح Admin إلا بعد الدعوة
          status: "pending",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        showTab("invite");
        alertSuccess("تم إنشاء الحساب. أدخل <b>كود دعوة أدمن</b> لتفعيل الصلاحيات.");
      }catch(e){ handleAuthError(e); }
    };

    /************* Invite Activation *************/
    window.activateInvite = async (ev)=>{
      ev.preventDefault(); clearGlobal();
      const code = $("#inviteCode").value.trim();
      if(!code) return alertError("الرجاء إدخال كود الدعوة.");

      const user = auth.currentUser;
      if(!user){ showTab("login"); return alertError("يرجى تسجيل الدخول أولًا أو إنشاء حساب ثم إدخال الكود."); }

      try{
        // get فقط وفق القواعد
        const invSnap = await getDoc(doc(db,"invites", code));
        if(!invSnap.exists()) return alertError("الكود غير موجود أو غير صالح.");
        const inv = invSnap.data();

        // القاعدة تمنح get فقط لو active==true ولم تنته الصلاحية
        // هنا نفترض أن الوثيقة تحتوي role: teacher|admin
        const role = inv.role;
        if(!["teacher","admin"].includes(role)) return alertError("نوع الدعوة غير معروف.");

        // تفعيل المستخدم
        await setDoc(doc(db,"users", user.uid),{
          role,
          status:"active",
          updatedAt: serverTimestamp()
        }, { merge:true });

        alertSuccess("تم التفعيل بنجاح! جارٍ توجيهك للوحة المناسبة…");
        setTimeout(()=>{
          if(role==="teacher") window.location.href="teacher-dashboard.html";
          else window.location.href="admin-dashboard.html";
        }, 700);
      }catch(e){
        handleAuthError(e);
      }
    };

    /************* Errors Map *************/
    function handleAuthError(e){
      const code = (e && e.code) || "";
      const map = {
        "auth/email-already-in-use": "البريد مستخدم مسبقًا.",
        "auth/invalid-email": "البريد غير صالح.",
        "auth/weak-password": "كلمة المرور ضعيفة (٦ أحرف على الأقل).",
        "auth/user-not-found": "لا يوجد حساب مطابق.",
        "auth/wrong-password": "كلمة المرور غير صحيحة.",
        "auth/too-many-requests": "محاولات كثيرة. جرّب لاحقًا.",
        "permission-denied": "ليست لديك صلاحية لهذه العملية حسب قواعد Firestore.",
      };
      console.error(e);
      alertError(map[code] || e.message || "حدث خطأ غير متوقع.");
    }

    // اختصار للخروج (مفيد أثناء التطوير)
    window.appSignOut = async ()=>{ await signOut(auth); alertSuccess("تم تسجيل الخروج."); showTab("login"); };
  </script>
</body>
</html>
